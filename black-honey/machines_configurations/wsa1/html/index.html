<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Gestione bilanci</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* RESET e BASE */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #fff;
      color: #222;
      padding: 40px 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    /* LOGIN */
    #login-container {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 30px 40px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 320px;
      width: 100%;
      text-align: center;
    }
    #login-container h2 {
      margin-bottom: 1.5rem;
      color: #111;
    }
    #login-container input[type="text"],
    #login-container input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 1rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      outline-offset: 2px;
      transition: border-color 0.3s ease;
    }
    #login-container input[type="text"]:focus,
    #login-container input[type="password"]:focus {
      border-color: #000;
    }
    #login-error {
      color: #c0392b;
      margin-bottom: 1rem;
      display: none;
    }
    #login-container button {
      padding: 10px 18px;
      font-size: 1rem;
      font-weight: 600;
      background-color: #000;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #login-container button:hover,
    #login-container button:focus-visible {
      background-color: #222;
      outline: none;
    }

    /* DASHBOARD (nascondiamo a inizio pagina) */
    #dashboard {
      display: none;
      width: 100%;
      max-width: 900px;
      flex-direction: column;
      align-items: center;
    }

    /* restano tutti gli stili originali */
    h1 {
      font-weight: 600;
      font-size: 2rem;
      margin-bottom: 2rem;
      color: #111;
    }

    #selettore-container {
      display: flex;
      gap: 12px;
      margin-bottom: 1.5rem;
      width: 100%;
      max-width: 900px;
      justify-content: center;
    }
    .btn-tab {
      background: none;
      border: none;
      padding: 10px 18px;
      font-size: 1rem;
      font-weight: 500;
      color: #555;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: color 0.3s ease, border-color 0.3s ease;
      user-select: none;
      outline-offset: 2px;
    }
    .btn-tab:hover,
    .btn-tab:focus-visible {
      color: #000;
      border-color: #000;
      outline: none;
    }
    .btn-tab.active {
      color: #000;
      border-color: #000;
      font-weight: 600;
      cursor: default;
      pointer-events: none;
    }
    #search-container {
      width: 100%;
      max-width: 900px;
      margin-bottom: 1rem;
    }
    #search {
      width: 100%;
      padding: 10px 16px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      outline-offset: 2px;
      transition: border-color 0.3s ease;
    }
    #search:focus {
      border-color: #000;
    }
    #contenuto {
      width: 100%;
      max-width: 900px;
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 24px 30px;
      min-height: 160px;
      user-select: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      font-size: 0.95rem;
      color: #333;
    }
    thead tr {
      border-bottom: 1px solid #ccc;
    }
    th, td {
      padding: 12px 15px;
      text-align: right;
      font-weight: 400;
      cursor: default;
      user-select: none;
    }
    th:first-child,
    td:first-child {
      text-align: left;
      font-weight: 600;
      color: #111;
      cursor: pointer;
      user-select: none;
    }
    th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    th.sortable:hover {
      color: #000;
    }
    th.sortable .sort-arrow {
      position: absolute;
      right: 8px;
      font-size: 0.7rem;
      user-select: none;
    }
    tbody tr {
      border-bottom: 1px solid #eee;
    }
    tbody tr:last-child {
      border-bottom: none;
    }
    td[style*="color:green"] {
      color: #1b7a1b;
      font-weight: 600;
    }
    td[style*="color:red"] {
      color: #a62a2a;
      font-weight: 600;
    }
    p {
      font-size: 1rem;
      color: #666;
      text-align: center;
      margin-top: 40px;
    }
    canvas#grafico {
      display: block;
      margin: 0 auto 60px auto;
      max-width: 900px;
      width: 100%;
      height: 380px !important;
    }
    #pagination {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
      max-width: 900px;
      user-select: none;
    }
    #pagination button {
      background: none;
      border: 1.5px solid #999;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 0.9rem;
      color: #555;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    #pagination button:hover:not(:disabled),
    #pagination button:focus-visible:not(:disabled) {
      border-color: #000;
      color: #000;
      outline: none;
      background-color: #eee;
    }
    #pagination button:disabled {
      border-color: #ddd;
      color: #bbb;
      cursor: default;
      background: none;
    }
    #pagination button.active {
      background-color: #000;
      color: #fff;
      border-color: #000;
      cursor: default;
      pointer-events: none;
      font-weight: 600;
    }
    @media (max-width: 600px) {
      body {
        padding: 30px 15px;
      }
      #selettore-container {
        gap: 8px;
        flex-wrap: wrap;
      }
      .btn-tab {
        padding: 8px 12px;
        font-size: 0.9rem;
        flex: 1 1 100px;
      }
      #contenuto {
        padding: 20px 15px;
        min-height: 140px;
      }
      canvas#grafico {
        height: 280px !important;
      }
      #pagination {
        gap: 4px;
      }
      #pagination button {
        padding: 5px 9px;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="login-container" role="dialog" aria-modal="true" aria-labelledby="login-title">
    <h2 id="login-title">Accesso Amministratore</h2>
    <div id="login-error" role="alert">Utente o password errati</div>
    <input type="text" id="username" placeholder="Nome utente" aria-label="Nome utente" autocomplete="username" />
    <input type="password" id="password" placeholder="Password" aria-label="Password" autocomplete="current-password" />
    <button id="login-btn">Accedi</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" role="main" aria-live="polite">
    <h1>Gestione bilanci</h1>

    <div id="selettore-container" role="tablist" aria-label="Seleziona tabella aziendale">
      <button class="btn-tab active" role="tab" aria-selected="true" data-endpoint="dipendenti.php" tabindex="0">Dipendenti</button>
      <button class="btn-tab" role="tab" aria-selected="false" data-endpoint="posizioni.php" tabindex="-1">Posizioni</button>
      <button class="btn-tab" role="tab" aria-selected="false" data-endpoint="entrate.php" tabindex="-1">Entrate</button>
      <button class="btn-tab" role="tab" aria-selected="false" data-endpoint="uscite.php" tabindex="-1">Uscite</button>
      <button class="btn-tab" role="tab" aria-selected="false" data-endpoint="bilanci_mensili.php" tabindex="-1">Bilanci Mensili</button>
      <!-- Nuova tab Bilanci Annuali -->
      <button class="btn-tab" role="tab" aria-selected="false" data-endpoint="bilanci_annuali.php" tabindex="-1">Bilanci Annuali</button>
    </div>

    <div id="search-container" style="display:none;">
      <input type="search" id="search" placeholder="Cerca nella tabella..." aria-label="Cerca nella tabella" />
    </div>

    <div id="contenuto" role="region" aria-live="polite" aria-busy="false" tabindex="0"></div>
    <div id="pagination" aria-label="Navigazione pagine tabella" style="display:none;"></div>
    <canvas id="grafico" style="display: none;"></canvas>
  </div>

  <script>
    // ELEMENTI
    const loginContainer = document.getElementById('login-container');
    const dashboard = document.getElementById('dashboard');
    const loginBtn = document.getElementById('login-btn');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginError = document.getElementById('login-error');

    // DASHBOARD ELEMENTI
    const buttons = document.querySelectorAll('#selettore-container .btn-tab');
    const contenuto = document.getElementById('contenuto');
    const canvas = document.getElementById('grafico');
    const searchContainer = document.getElementById('search-container');
    const searchInput = document.getElementById('search');
    const pagination = document.getElementById('pagination');

    let chart = null;
    let currentData = [];
    let filteredData = [];
    const rowsPerPage = 30;
    let currentPage = 1;
    let sortColumn = null;
    let sortDirection = 1;

    // LOGIN: semplice controllo username/password "admin/admin"
    loginBtn.addEventListener('click', () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();

      if (username === 'admin' && password === 'admin') {
        loginError.style.display = 'none';
        loginContainer.style.display = 'none';
        dashboard.style.display = 'flex';
        // Avvia dashboard
        avviaDashboard();
      } else {
        loginError.style.display = 'block';
      }
    });

    // Login anche con Invio su input password
    passwordInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        loginBtn.click();
      }
    });

    // Funzione che inizializza dashboard (tab e caricamento dati)
    function avviaDashboard() {
      // Aggiungo listener tab (già definiti, quindi rieseguo)
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          if (button.classList.contains('active')) return;

          buttons.forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
            btn.setAttribute('tabindex', '-1');
          });

          button.classList.add('active');
          button.setAttribute('aria-selected', 'true');
          button.setAttribute('tabindex', '0');
          button.focus();

          searchInput.value = '';
          currentPage = 1;
          sortColumn = null;
          sortDirection = 1;
          caricaTabella(button.dataset.endpoint);
        });
      });

      // Carica tab attiva (Dipendenti)
      caricaTabella(buttons[0].dataset.endpoint);

      // Cerca (filtro)
      searchInput.addEventListener('input', () => {
        filtraTabella();
      });
    }

    // Funzione per caricare dati da endpoint e renderizzare tabella e grafico se serve
    async function caricaTabella(endpoint) {
      contenuto.setAttribute('aria-busy', 'true');
      contenuto.innerHTML = 'Caricamento dati...';
      pagination.style.display = 'none';
      canvas.style.display = 'none';
      searchContainer.style.display = 'none';

      try {
        const res = await fetch(endpoint);
        if (!res.ok) throw new Error(`Errore caricamento dati da ${endpoint}`);

        const dati = await res.json();
        currentData = dati;
        filteredData = dati;

        // Se la tab è bilanci mensili o annuali mostriamo grafico e non tabella
        if (endpoint === 'bilanci_mensili.php' || endpoint === 'bilanci_annuali.php') {
          renderizzaGrafico(dati, endpoint);
          contenuto.innerHTML = '';
          pagination.style.display = 'none';
          searchContainer.style.display = 'none';
        } else {
          canvas.style.display = 'none';
          searchContainer.style.display = 'block';
          renderizzaTabella();
          pagination.style.display = 'flex';
        }
      } catch (e) {
        contenuto.innerHTML = `<p>Errore: ${e.message}</p>`;
        pagination.style.display = 'none';
      }
      contenuto.setAttribute('aria-busy', 'false');
    }

    // Render tabella filtrata e paginata
    function renderizzaTabella() {
      if (!filteredData.length) {
        contenuto.innerHTML = '<p>Nessun dato disponibile.</p>';
        pagination.style.display = 'none';
        return;
      }

      // Ordinamento se attivo
      let datiOrdinati = [...filteredData];
      if (sortColumn !== null) {
        datiOrdinati.sort((a, b) => {
          let valA = a[sortColumn];
          let valB = b[sortColumn];

          // Se numeri
          if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB))) {
            valA = parseFloat(valA);
            valB = parseFloat(valB);
          } else {
            // Se stringhe, case insensitive
            valA = valA.toString().toLowerCase();
            valB = valB.toString().toLowerCase();
          }

          if (valA > valB) return sortDirection;
          if (valA < valB) return -sortDirection;
          return 0;
        });
      }

      // Paginazione
      const totalePagine = Math.ceil(datiOrdinati.length / rowsPerPage);
      if (currentPage > totalePagine) currentPage = 1;
      const inizio = (currentPage - 1) * rowsPerPage;
      const fine = inizio + rowsPerPage;
      const paginaDati = datiOrdinati.slice(inizio, fine);

      // Costruiamo la tabella HTML
      const intestazioni = Object.keys(paginaDati[0]);
      let html = '<table><thead><tr>';

      intestazioni.forEach((key) => {
        // Rendiamo ordinabili tutte le colonne
        html += `<th class="sortable" data-key="${key}" tabindex="0" role="button" aria-pressed="${sortColumn === key}">${key}`;
        if (sortColumn === key) {
          html += `<span class="sort-arrow">${sortDirection === 1 ? '▲' : '▼'}</span>`;
        }
        html += '</th>';
      });
      html += '</tr></thead><tbody>';

      paginaDati.forEach(row => {
        html += '<tr>';
        intestazioni.forEach(key => {
          // Colorazioni su valori numerici positivi o negativi (esempio)
          let style = '';
          if (!isNaN(row[key])) {
            const val = parseFloat(row[key]);
            if (val > 0) style = 'color:green';
            else if (val < 0) style = 'color:red';
          }
          html += `<td style="${style}">${row[key]}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      contenuto.innerHTML = html;

      // Paginazione
      renderizzaPaginazione(totalePagine);

      // Attiviamo ordinamento click e tastiera sui th
      const thElements = contenuto.querySelectorAll('th.sortable');
      thElements.forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.key;
          if (sortColumn === key) {
            sortDirection = -sortDirection; // inverti
          } else {
            sortColumn = key;
            sortDirection = 1;
          }
          renderizzaTabella();
        });
        th.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            th.click();
          }
        });
      });
    }

    // Renderizza la paginazione sotto tabella
    function renderizzaPaginazione(totalePagine) {
      pagination.innerHTML = '';
      if (totalePagine <= 1) {
        pagination.style.display = 'none';
        return;
      }

      pagination.style.display = 'flex';

      // Pulsante precedente
      const btnPrev = document.createElement('button');
      btnPrev.textContent = '‹';
      btnPrev.disabled = currentPage === 1;
      btnPrev.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderizzaTabella();
          contenuto.focus();
        }
      });
      pagination.appendChild(btnPrev);

      // Pulsanti pagina
      for (let i = 1; i <= totalePagine; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = (i === currentPage) ? 'active' : '';
        btn.disabled = (i === currentPage);
        btn.addEventListener('click', () => {
          currentPage = i;
          renderizzaTabella();
          contenuto.focus();
        });
        pagination.appendChild(btn);
      }

      // Pulsante successivo
      const btnNext = document.createElement('button');
      btnNext.textContent = '›';
      btnNext.disabled = currentPage === totalePagine;
      btnNext.addEventListener('click', () => {
        if (currentPage < totalePagine) {
          currentPage++;
          renderizzaTabella();
          contenuto.focus();
        }
      });
      pagination.appendChild(btnNext);
    }

    // Filtra dati in base a input ricerca
    function filtraTabella() {
      const term = searchInput.value.trim().toLowerCase();
      if (!term) {
        filteredData = currentData;
      } else {
        filteredData = currentData.filter(row => {
          return Object.values(row).some(value =>
            String(value).toLowerCase().includes(term)
          );
        });
      }
      currentPage = 1;
      renderizzaTabella();
    }

    // Render grafico per bilanci mensili o annuali
    function renderizzaGrafico(dati, endpoint) {
      canvas.style.display = 'block';

      // Distruggi vecchio chart
      if (chart) chart.destroy();

      // Preparo dati
      let labels = [];
      let datasetEntrate = [];
      let datasetUscite = [];

      if (endpoint === 'bilanci_mensili.php') {
        // Supponiamo dati come [{mese: "Gennaio", entrate: 123, uscite: 100}, ...]
        labels = dati.map(d => d.mese);
        datasetEntrate = dati.map(d => Number(d.entrate));
        datasetUscite = dati.map(d => Number(d.uscite));
      } else if (endpoint === 'bilanci_annuali.php') {
        // Supponiamo dati come [{anno: "2022", entrate: 12345, uscite: 10000}, ...]
        labels = dati.map(d => d.anno);
        datasetEntrate = dati.map(d => Number(d.entrate));
        datasetUscite = dati.map(d => Number(d.uscite));
      }

      const data = {
        labels: labels,
        datasets: [
          {
            label: 'Entrate',
            data: datasetEntrate,
            backgroundColor: 'rgba(36, 148, 36, 0.6)',
            borderColor: 'rgba(36, 148, 36, 1)',
            borderWidth: 1
          },
          {
            label: 'Uscite',
            data: datasetUscite,
            backgroundColor: 'rgba(194, 64, 64, 0.6)',
            borderColor: 'rgba(194, 64, 64, 1)',
            borderWidth: 1
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              font: {
                size: 14
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              font: { size: 13 },
              color: '#555',
              callback: function(value) {
                return value.toLocaleString();
              }
            }
          },
          x: {
            ticks: {
              font: { size: 13 },
              color: '#555'
            }
          }
        }
      };

      chart = new Chart(canvas, {
        type: 'bar',
        data: data,
        options: options
      });
    }
  </script>
</body>
</html>
